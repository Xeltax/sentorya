name: ğŸš€ Build and Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:  # Permet de lancer manuellement depuis GitHub

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/sentorya
  REPO_OWNER_LOWER: ${{ github.repository_owner }}

jobs:
  # =====================================
  # Job 1: Build et Push les images Docker
  # =====================================
  build-and-push:
    name: ğŸ—ï¸ Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      version: ${{ steps.meta.outputs.version }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”¤ Convert repo owner to lowercase
        id: lowercase
        run: |
          echo "owner=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION=${{ github.event.release.tag_name }}
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      # Build Backend
      - name: ğŸ—ï¸ Build Backend Image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:${{ steps.meta.outputs.version }} \
            -t ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:latest \
            -f back/Dockerfile \
            ./back

      # Build Frontend
      - name: ğŸ—ï¸ Build Frontend Image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:${{ steps.meta.outputs.version }} \
            -t ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:latest \
            -f front/Dockerfile \
            ./front

      # Push Backend
      - name: ğŸ“¤ Push Backend Image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:${{ steps.meta.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:latest

      # Push Frontend
      - name: ğŸ“¤ Push Frontend Image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:${{ steps.meta.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:latest

      - name: âœ… Build Summary
        run: |
          echo "### ğŸ‰ Images Docker crÃ©Ã©es avec succÃ¨s !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”§ Backend: \`${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¨ Frontend: \`${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # =====================================
  # Job 2: DÃ©ployer sur le serveur
  # =====================================
  deploy:
    name: ğŸš¢ Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: ğŸ“¥ Checkout deployment files
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docker-compose.prod.yml
            nginx

      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Copy deployment files to server
        run: |
          scp -i ~/.ssh/id_rsa docker-compose.prod.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/sentorya/docker-compose.yml
          scp -r -i ~/.ssh/id_rsa nginx ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/sentorya/

      - name: ğŸš€ Deploy on server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd ~/sentorya
          
            echo "ğŸ“¦ Logging into GitHub Container Registry..."
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
            echo "ğŸ”„ Pulling new images..."
            docker-compose pull
          
            echo "ğŸ›‘ Stopping old containers..."
            docker-compose down
          
            echo "ğŸš€ Starting new containers..."
            docker-compose up -d
          
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af
          
            echo "âœ… Deployment completed!"
          
            echo "ğŸ¥ Checking health..."
            sleep 10
            docker-compose ps
          ENDSSH

      - name: ğŸ¥ Health Check
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ~/sentorya
          
            # Attendre que les services dÃ©marrent
            echo "â³ Waiting for services to start..."
            sleep 30
          
            # VÃ©rifier Nginx
            if curl -f http://localhost/health > /dev/null 2>&1; then
              echo "âœ… Nginx: OK"
            else
              echo "âŒ Nginx: FAILED"
              exit 1
            fi
          
            # VÃ©rifier Backend
            if docker-compose exec -T backend curl -f http://localhost:5000/actuator/health > /dev/null 2>&1; then
              echo "âœ… Backend: OK"
            else
              echo "âŒ Backend: FAILED"
              exit 1
            fi
          
            # VÃ©rifier Frontend
            if docker-compose exec -T frontend curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… Frontend: OK"
            else
              echo "âŒ Frontend: FAILED"
              exit 1
            fi
          
            echo "ğŸ‰ All services are healthy!"
          ENDSSH

      - name: ğŸ“Š Deployment Summary
        if: success()
        run: |
          echo "### ğŸ‰ DÃ©ploiement rÃ©ussi sur le serveur !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version dÃ©ployÃ©e:** \`${{ needs.build-and-push.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services dÃ©ployÃ©s:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Nginx (Reverse Proxy)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backend (Spring Boot)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend (Next.js)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PostgreSQL (Database)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Rollback on failure
        if: failure()
        run: |
          echo "ğŸ”„ Rolling back to previous version..."
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ~/sentorya
            docker-compose down
            docker-compose up -d
          ENDSSH
          echo "âš ï¸ Deployment failed. Previous version restored." >> $GITHUB_STEP_SUMMARY

  # =====================================
  # Job 3: Notification (optionnel)
  # =====================================
  notify:
    name: ğŸ“¢ Send Notification
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    if: always()
    
    steps:
      - name: ğŸ“¢ Notify Success
        if: needs.deploy.result == 'success'
        run: |
          echo "âœ… Deployment successful for version ${{ needs.build-and-push.outputs.version }}"
          # Ici tu peux ajouter Discord, Slack, email, etc.

      - name: ğŸ“¢ Notify Failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ Deployment failed for version ${{ needs.build-and-push.outputs.version }}"
          # Ici tu peux ajouter Discord, Slack, email, etc.