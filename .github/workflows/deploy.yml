name: üöÄ Build and Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:  # Permet de lancer manuellement depuis GitHub

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/sentorya
  REPO_OWNER_LOWER: ${{ github.repository_owner }}

jobs:
  # =====================================
  # Job 1: Build et Push les images Docker
  # =====================================
  build-and-push:
    name: üèóÔ∏è Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üî§ Convert repo owner to lowercase
        id: lowercase
        run: |
          echo "owner=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: üè∑Ô∏è Extract metadata
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION=${{ github.event.release.tag_name }}
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

      # Build Backend
      - name: üèóÔ∏è Build Backend Image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:${{ steps.meta.outputs.version }} \
            -t ${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:latest \
            -f back/Dockerfile \
            ./back

      # Build Frontend
      - name: üèóÔ∏è Build Frontend Image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:${{ steps.meta.outputs.version }} \
            -t ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:latest \
            -f front/Dockerfile \
            ./front

      # Push Backend
      - name: üì§ Push Backend Image
        run: |
          docker push ${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:${{ steps.meta.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:latest

      # Push Frontend
      - name: üì§ Push Frontend Image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:${{ steps.meta.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:latest

      - name: ‚úÖ Build Summary
        run: |
          echo "### üéâ Images Docker cr√©√©es avec succ√®s !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- üîß Backend: \`${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- üé® Frontend: \`${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # =====================================
  # Job 2: D√©ployer sur le serveur
  # =====================================
  deploy:
    name: üö¢ Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: üì• Checkout deployment files
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docker-compose-prod.yml
            nginx

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: üì§ Copy deployment files to server
        run: |
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} -o StrictHostKeyChecking=no" \
            docker-compose-prod.yml \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/sentorya/docker-compose.yml
          
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} -o StrictHostKeyChecking=no" \
            nginx/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/sentorya/nginx/

      - name: üöÄ Deploy on server
        run: |
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd ~/sentorya
          
            echo "üì¶ Logging into GitHub Container Registry..."
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
            echo "üîÑ Pulling new images..."
            docker-compose pull
          
            echo "üõë Stopping old containers..."
            docker-compose down
          
            echo "üöÄ Starting new containers..."
            docker-compose up -d
          
            echo "üßπ Cleaning up old images..."
            docker image prune -af
          
            echo "‚úÖ Deployment completed!"
          
            echo "üè• Checking health..."
            sleep 10
            docker-compose ps
          ENDSSH

      - name: üè• Health Check
        run: |
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ~/sentorya
          
            # Attendre que les services d√©marrent
            echo "‚è≥ Waiting for services to start..."
            sleep 30
          
            # V√©rifier Nginx
            if curl -f http://localhost/health > /dev/null 2>&1; then
              echo "‚úÖ Nginx: OK"
            else
              echo "‚ùå Nginx: FAILED"
              exit 1
            fi
          
            # V√©rifier Backend
            if docker-compose exec -T backend curl -f http://localhost:5000/actuator/health > /dev/null 2>&1; then
              echo "‚úÖ Backend: OK"
            else
              echo "‚ùå Backend: FAILED"
              exit 1
            fi
          
            # V√©rifier Frontend
            if docker-compose exec -T frontend curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "‚úÖ Frontend: OK"
            else
              echo "‚ùå Frontend: FAILED"
              exit 1
            fi
          
            echo "üéâ All services are healthy!"
          ENDSSH

      - name: üìä Deployment Summary
        if: success()
        run: |
          echo "### üéâ D√©ploiement r√©ussi sur le serveur !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version d√©ploy√©e:** \`${{ needs.build-and-push.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services d√©ploy√©s:**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Nginx (Reverse Proxy)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Backend (Spring Boot)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Frontend (Next.js)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ PostgreSQL (Database)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Rollback on failure
        if: failure()
        run: |
          echo "üîÑ Rolling back to previous version..."
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ~/sentorya
            docker-compose down
            docker-compose up -d
          ENDSSH
          echo "‚ö†Ô∏è Deployment failed. Previous version restored." >> $GITHUB_STEP_SUMMARY

  # =====================================
  # Job 3: Notification (optionnel)
  # =====================================
  notify:
    name: üì¢ Send Notification
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    if: always()
    
    steps:
      - name: üì¢ Notify Success
        if: needs.deploy.result == 'success'
        run: |
          echo "‚úÖ Deployment successful for version ${{ needs.build-and-push.outputs.version }}"
          # Ici tu peux ajouter Discord, Slack, email, etc.

      - name: üì¢ Notify Failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "‚ùå Deployment failed for version ${{ needs.build-and-push.outputs.version }}"
          # Ici tu peux ajouter Discord, Slack, email, etc.