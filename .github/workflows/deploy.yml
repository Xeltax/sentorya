name: üöÄ Build and Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:  # Permet de lancer manuellement depuis GitHub

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/sentorya
  REPO_OWNER_LOWER: ${{ github.repository_owner }}

jobs:
  # =====================================
  # Job 1: Build et Push les images Docker
  # =====================================
  build-and-push:
    name: üèóÔ∏è Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: üì¢ Discord - D√©marrage du d√©ploiement
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MESSAGE=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          AUTHOR_AVATAR="https://github.com/${{ github.actor }}.png"
          
          curl -H "Content-Type: application/json" -X POST -d '{
            "embeds": [{
              "title": "üöÄ D√©ploiement en cours...",
              "description": "Le pipeline CI/CD vient de d√©marrer",
              "color": 3447003,
              "fields": [
                {
                  "name": "üì¶ Repository",
                  "value": "[${{ github.repository }}](https://github.com/${{ github.repository }})",
                  "inline": true
                },
                {
                  "name": "üåø Branche",
                  "value": "`${{ github.ref_name }}`",
                  "inline": true
                },
                {
                  "name": "üë§ Auteur",
                  "value": "[${{ github.actor }}](https://github.com/${{ github.actor }})",
                  "inline": true
                },
                {
                  "name": "üí¨ Commit",
                  "value": "[`${{ github.sha }}`.substring(0,7)]('$COMMIT_URL')\n```'$COMMIT_MESSAGE'```",
                  "inline": false
                },
                {
                  "name": "üîó Actions",
                  "value": "[Voir le workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                  "inline": false
                }
              ],
              "thumbnail": {
                "url": "'$AUTHOR_AVATAR'"
              },
              "footer": {
                "text": "Sentorya CI/CD",
                "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
              },
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
            }]
          }' $DISCORD_WEBHOOK
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üî§ Convert repo owner to lowercase
        id: lowercase
        run: |
          echo "owner=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: üè∑Ô∏è Extract metadata
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION=${{ github.event.release.tag_name }}
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

      # Build Backend
      - name: üèóÔ∏è Build Backend Image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:${{ steps.meta.outputs.version }} \
            -t ${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:latest \
            -f back/Dockerfile \
            ./back

      # Build Frontend
      - name: üèóÔ∏è Build Frontend Image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:${{ steps.meta.outputs.version }} \
            -t ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:latest \
            -f front/Dockerfile \
            ./front

      # Push Backend
      - name: üì§ Push Backend Image
        run: |
          docker push ${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:${{ steps.meta.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:latest

      # Push Frontend
      - name: üì§ Push Frontend Image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:${{ steps.meta.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:latest

      - name: ‚úÖ Build Summary
        run: |
          echo "### üéâ Images Docker cr√©√©es avec succ√®s !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- üîß Backend: \`${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-backend:${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- üé® Frontend: \`${{ env.REGISTRY }}/${{ env.REGISTRY }}/${{ steps.lowercase.outputs.owner }}/sentorya-frontend:${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # =====================================
  # Job 2: D√©ployer sur le serveur
  # =====================================
  deploy:
    name: üö¢ Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: üì• Checkout deployment files
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docker-compose-prod.yml
            nginx

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: üì§ Copy deployment files to server
        run: |
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} -o StrictHostKeyChecking=no" \
            docker-compose-prod.yml \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/sentorya/docker-compose.yml
          
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} -o StrictHostKeyChecking=no" \
            nginx/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/sentorya/nginx/

      - name: üöÄ Deploy on server
        run: |
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd ~/sentorya
          
            echo "üì¶ Logging into GitHub Container Registry..."
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
            echo "üîÑ Pulling new images..."
            docker-compose pull
          
            echo "üõë Stopping old containers..."
            docker-compose down
          
            echo "üöÄ Starting new containers..."
            docker-compose up -d
          
            echo "üßπ Cleaning up old images..."
            docker image prune -af
          
            echo "‚úÖ Deployment completed!"
          
            echo "üè• Checking health..."
            sleep 10
            docker-compose ps
          ENDSSH

      - name: üè• Health Check
        run: |
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ~/sentorya
          
            # Attendre que les services d√©marrent
            echo "‚è≥ Waiting for services to start..."
            sleep 30
          
            # V√©rifier Nginx
            if curl -f http://localhost/health > /dev/null 2>&1; then
              echo "‚úÖ Nginx: OK !"
            else
              echo "‚ùå Nginx: FAILED"
              exit 1
            fi
          
            # V√©rifier Backend
            echo "‚ö†Ô∏è Backend health check disabled for now"
          
            # V√©rifier Frontend
            if curl -s -o /dev/null -w "%{http_code}" http://localhost/ | grep -qE "^[23]"; then
              echo "‚úÖ Frontend: OK"
            else
              echo "‚ùå Frontend: FAILED"
              exit 1
            fi
          
            echo "üéâ All services are healthy!"
          ENDSSH

      - name: üìä Deployment Summary
        if: success()
        run: |
          echo "### üéâ D√©ploiement r√©ussi sur le serveur !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version d√©ploy√©e:** \`${{ needs.build-and-push.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services d√©ploy√©s:**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Nginx (Reverse Proxy)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Backend (Spring Boot)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Frontend (Next.js)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ PostgreSQL (Database)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Rollback on failure
        if: failure()
        run: |
          echo "üîÑ Rolling back to previous version..."
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ~/sentorya
            docker-compose down
            docker-compose up -d
          ENDSSH
          echo "‚ö†Ô∏è Deployment failed. Previous version restored." >> $GITHUB_STEP_SUMMARY

  # =====================================
  # Job 3: Notification (optionnel)
  # =====================================
  notify:
    name: üì¢ Send Notification
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    if: always()

    steps:
      - name: ‚úÖ Discord - D√©ploiement r√©ussi
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MESSAGE=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          DURATION=$(($(date +%s) - ${{ github.event.repository.pushed_at }}))
          
          curl -H "Content-Type: application/json" -X POST -d '{
            "embeds": [{
              "title": "‚úÖ D√©ploiement r√©ussi !",
              "description": "L'\''application a √©t√© d√©ploy√©e avec succ√®s en production",
              "color": 5763719,
              "fields": [
                {
                  "name": "üì¶ Repository",
                  "value": "[${{ github.repository }}](https://github.com/${{ github.repository }})",
                  "inline": true
                },
                {
                  "name": "üåø Branche",
                  "value": "`${{ github.ref_name }}`",
                  "inline": true
                },
                {
                  "name": "üë§ D√©ploy√© par",
                  "value": "[${{ github.actor }}](https://github.com/${{ github.actor }})",
                  "inline": true
                },
                {
                  "name": "üí¨ Commit",
                  "value": "[`${{ github.sha }}`.substring(0,7)]('$COMMIT_URL')\n```'$COMMIT_MESSAGE'```",
                  "inline": false
                },
                {
                  "name": "‚è±Ô∏è Dur√©e",
                  "value": "~2-3 minutes",
                  "inline": true
                },
                {
                  "name": "üåê Environnement",
                  "value": "Production",
                  "inline": true
                },
                {
                  "name": "üîó Liens",
                  "value": "[Voir le workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ‚Ä¢ [Voir le commit]('$COMMIT_URL')",
                  "inline": false
                }
              ],
              "thumbnail": {
                "url": "https://cdn-icons-png.flaticon.com/512/190/190411.png"
              },
              "footer": {
                "text": "Sentorya CI/CD ‚Ä¢ D√©ploiement r√©ussi",
                "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
              },
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
            }]
          }' $DISCORD_WEBHOOK

      - name: ‚ùå Discord - D√©ploiement √©chou√©
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MESSAGE=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

          curl -H "Content-Type: application/json" -X POST -d '{
            "embeds": [{
              "title": "‚ùå √âchec du d√©ploiement",
              "description": "Le d√©ploiement a rencontr√© une erreur",
              "color": 15158332,
              "fields": [
                {
                  "name": "üì¶ Repository",
                  "value": "[${{ github.repository }}](https://github.com/${{ github.repository }})",
                  "inline": true
                },
                {
                  "name": "üåø Branche",
                  "value": "`${{ github.ref_name }}`",
                  "inline": true
                },
                {
                  "name": "üë§ Auteur",
                  "value": "[${{ github.actor }}](https://github.com/${{ github.actor }})",
                  "inline": true
                },
                {
                  "name": "üí¨ Commit",
                  "value": "[`${{ github.sha }}`.substring(0,7)]('$COMMIT_URL')\n```'$COMMIT_MESSAGE'```",
                  "inline": false
                },
                {
                  "name": "üîç Action requise",
                  "value": "V√©rifiez les logs du workflow pour identifier le probl√®me",
                  "inline": false
                },
                {
                  "name": "üîó Liens",
                  "value": "[üìã Voir les logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ‚Ä¢ [üí¨ Voir le commit]('$COMMIT_URL')",
                  "inline": false
                }
              ],
              "thumbnail": {
                "url": "https://cdn-icons-png.flaticon.com/512/753/753345.png"
              },
              "footer": {
                "text": "Sentorya CI/CD ‚Ä¢ Erreur d√©tect√©e",
                "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
              },
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
            }]
          }' $DISCORD_WEBHOOK