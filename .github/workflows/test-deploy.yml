name: ðŸ§ª Test Deploy Only

on:
  workflow_dispatch:  # Lancement manuel uniquement

jobs:
  deploy:
    name: ðŸš¢ Test Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout deployment files
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“¤ Copy deployment files to server
        run: |
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} -o StrictHostKeyChecking=no" \
            docker-compose-prod.yml \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/sentorya/docker-compose.yml
          
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} -o StrictHostKeyChecking=no" \
            nginx/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/sentorya/nginx/

      - name: ðŸš€ Test SSH commands
        run: |
          ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd ~/sentorya
            echo "âœ… Connected to server!"
            ls -la
            docker --version
            docker-compose --version
          ENDSSH